(() => {
  const $ = (s) => document.querySelector(s);

  // ✅ 自动适配：无论你 Pages 是 /assets/ 还是自定义域名，都不会错
  const BASE_URL = new URL("./", window.location.href); // e.g. https://byshelby.github.io/assets/
  const MANIFEST_URL = new URL("data/manifest.json", BASE_URL).toString();

  // 你的 GitHub 仓库信息（Raw 链接需要）
  const OWNER = "byShelby";
  const REPO  = "assets";
  const BRANCH = "main";

  const i18n = {
    zh: {
      title: "你的资源库",
      subtitle: "干净、可复制直链、可预览。",
      searchPH: "搜索：avatar / icon / photo",
      empty: "这个分类还没有资源",
      copied: "已复制",
      copyPages: "复制 Pages 直链",
      copyRaw: "复制 Raw 直链",
      open: "打开",
      manifestFail: "资源索引加载失败"
    },
    en: {
      title: "Asset Library",
      subtitle: "Clean. Copyable links. Previewable.",
      searchPH: "Search: avatar / icon / photo",
      empty: "No assets in this category",
      copied: "Copied",
      copyPages: "Copy Pages Link",
      copyRaw: "Copy Raw Link",
      open: "Open",
      manifestFail: "Manifest load failed"
    }
  };

  let lang = "zh";

  const repoBtn = $("#repoBtn");
  repoBtn.href = `https://github.com/${OWNER}/${REPO}`;

  const langBtn = $("#langBtn");
  langBtn.addEventListener("click", () => {
    lang = (lang === "zh") ? "en" : "zh";
    langBtn.textContent = (lang === "zh") ? "EN" : "中文";
    applyLang();
    render(lastManifest);
  });

  function applyLang(){
    $("#title").textContent = i18n[lang].title;
    $("#subtitle").textContent = i18n[lang].subtitle;
    $("#q").placeholder = i18n[lang].searchPH;
    $("#copyPages").textContent = i18n[lang].copyPages;
    $("#copyRaw").textContent = i18n[lang].copyRaw;
    $("#openNew").textContent = i18n[lang].open;
  }
  applyLang();

  function pagesLink(path){
    // ✅ 永远正确：用 BASE_URL 拼
    return new URL(path, BASE_URL).toString();
  }
  function rawLink(path){
    // ✅ 自动生成 Raw：无需你手动编辑
    return `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${path}`;
  }

  async function copy(text){
    await navigator.clipboard.writeText(text);
  }

  // Modal
  const modal = $("#modal");
  const modalImg = $("#modalImg");
  const modalName = $("#modalName");
  const modalPath = $("#modalPath");
  const openNew = $("#openNew");
  const copyPagesBtn = $("#copyPages");
  const copyRawBtn = $("#copyRaw");

  function openModal(assetPath){
    const pUrl = pagesLink(assetPath);
    const rUrl = rawLink(assetPath);

    modal.setAttribute("aria-hidden", "false");
    modalImg.src = pUrl;
    modalName.textContent = assetPath.split("/").pop();
    modalPath.textContent = assetPath;

    openNew.href = pUrl;

    copyPagesBtn.onclick = async () => {
      await copy(pUrl);
      copyPagesBtn.textContent = i18n[lang].copied;
      setTimeout(()=> copyPagesBtn.textContent = i18n[lang].copyPages, 900);
    };
    copyRawBtn.onclick = async () => {
      await copy(rUrl);
      copyRawBtn.textContent = i18n[lang].copied;
      setTimeout(()=> copyRawBtn.textContent = i18n[lang].copyRaw, 900);
    };
  }
  function closeModal(){
    modal.setAttribute("aria-hidden", "true");
    modalImg.src = "";
  }
  $("#modalClose").addEventListener("click", closeModal);
  modal.addEventListener("click", (e) => {
    if (e.target?.dataset?.close) closeModal();
  });
  window.addEventListener("keydown", (e)=> {
    if (e.key === "Escape") closeModal();
  });

  // Render
  const grid = $("#grid");
  const q = $("#q");
  const status = $("#status");

  let lastManifest = null;

  q.addEventListener("input", () => render(lastManifest));

  function normalizeList(groups){
    // groups: {root:[...], people:[...]} -> flatten with group name
    const out = [];
    for (const [group, arr] of Object.entries(groups || {})){
      (arr || []).forEach(p => out.push({ group, path: p }));
    }
    return out;
  }

  function render(manifest){
    if(!manifest) return;
    const kw = (q.value || "").trim().toLowerCase();

    grid.innerHTML = "";

    const cats = manifest.categories || {};
    const entries = Object.entries(cats);

    for (const [catName, catObj] of entries){
      const groups = catObj.groups || {};
      const list = normalizeList(groups);

      const filtered = kw
        ? list.filter(x => (x.path + " " + x.group + " " + catName).toLowerCase().includes(kw))
        : list;

      const card = document.createElement("div");
      card.className = "card";

      const head = document.createElement("div");
      head.className = "cardHead";

      const left = document.createElement("div");
      const title = document.createElement("div");
      title.className = "cardTitle";
      title.textContent = catName[0].toUpperCase() + catName.slice(1);

      const sub = document.createElement("div");
      sub.className = "cardSub";
      sub.textContent = `${catObj.total || 0}`;

      left.appendChild(title);
      left.appendChild(sub);

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = "root"; // 你现在不想复杂分组，就显示 root（后面你要分类我再给你升级）

      head.appendChild(left);
      head.appendChild(badge);

      card.appendChild(head);

      if (filtered.length === 0){
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = i18n[lang].empty;
        card.appendChild(empty);
      } else {
        const tg = document.createElement("div");
        tg.className = "thumbGrid";

        // 展示前 12 个缩略图（避免页面炸裂）；搜索时也是这样
        const show = filtered.slice(0, 12);

        for (const item of show){
          const btn = document.createElement("div");
          btn.className = "thumb";
          const img = document.createElement("img");
          img.loading = "lazy";
          img.src = pagesLink(item.path);
          img.alt = item.path;
          btn.appendChild(img);
          btn.addEventListener("click", () => openModal(item.path));
          tg.appendChild(btn);
        }
        card.appendChild(tg);
      }

      grid.appendChild(card);
    }

    status.textContent = "";
  }

  async function main(){
    status.textContent = "Loading…";
    try{
      const res = await fetch(MANIFEST_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("manifest http " + res.status);
      const manifest = await res.json();
      lastManifest = manifest;
      status.textContent = "";
      render(manifest);
    }catch(err){
      console.error(err);
      status.textContent = i18n[lang].manifestFail + " · " + MANIFEST_URL;
    }
  }

  main();
})();
